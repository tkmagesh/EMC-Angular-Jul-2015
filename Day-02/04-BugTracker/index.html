<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bug Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!--
    Use cases
    =========
    1. List the bugs - done
    2. Add a new bug - done
    3. Toggle the 'closed' status of a bug (use ng-class) - done
    4. Remove Closed bugs - done
    5. Display stats -  done
    6. Search for the bugs - done
    7. Sort the bugs - done
    8. Display the "createdAt" - done
    9. Persist the bugs in the storage
    10. Make the storage option (localStorage or sessionStorage) configurable
    11. Persist the bugs in the server
    12. Enable routing
    13. Add 'project' support

    localStorage
    ============
    window.localStorage
        - key/value store
        - key and value should be strings

        - setItem(key, value)
        - getItem(key) // -> value
        - removeItem(key)
        - key(index) // -> key
        - clear()
        - length

    -->
    <script src="angular.js"></script>
    <script src="moment.js"></script>
    <script>



        var bugTrackerApp = angular.module("bugTrackerApp", []);

        bugTrackerApp.factory("Bug", function getBug(){
            function Bug(defaults){
                defaults = defaults || {};
                this.name = defaults.name || '';
                this.isClosed = defaults.isClosed || false;
                this.createdAt = defaults.createdAt || new Date();
            }
            Bug.prototype.toggle = function(){
                this.isClosed = !this.isClosed;
            }
            return Bug;
        });

       /* bugTrackerApp.value("Bug", (function getBug(){
            function Bug(defaults){
                defaults = defaults || {};
                this.name = defaults.name || '';
                this.isClosed = defaults.isClosed || false;
            }
            Bug.prototype.toggle = function(){
                this.isClosed = !this.isClosed;
            }
            return Bug;
        })());*/

        bugTrackerApp.factory("bugStore", function(Bug){
            return {
                getAll : function(){
                    return [
                        new Bug({name : "Stack overflow error", isClosed : false, createdAt : new Date(2015, 6, 13)}),
                        new Bug({name : "Object reference not found", isClosed : true, createdAt : new Date(2015, 6, 14)}),
                        new Bug({name : "Invalid operation performed", isClosed : true, createdAt : new Date(2015, 6, 12)}),
                        new Bug({name : "Server communication error", isClosed : false, createdAt : new Date(2015, 5, 13)})
                    ];
                }
            }
        })

        bugTrackerApp.controller("bugsController", function($scope, Bug, bugStore){
            $scope.bugs = bugStore.getAll();
            $scope.newBug = ''
            $scope.addNew = function(){
                $scope.bugs.push(new Bug({
                    name : $scope.newBug
                    }));
                $scope.newBug = '';
            };
            $scope.toggle = function(bug){
                bug.toggle();
            };
            $scope.getClosedCount = function(){
                return $scope.bugs.filter(function(bug){
                    return bug.isClosed;
                }).length;
            };
            $scope.removeClosed = function(){
                for(var i=$scope.bugs.length -1; i>=0; i--){
                    if ($scope.bugs[i].isClosed){
                        $scope.bugs.splice(i,1);
                    }
                }
            };

        });
        /*bugTrackerApp.filter("closedCount", function(){
            return function(data){
                var result = 0;
                for(var i=0; i<data.length; i++)
                    if (data[i].isClosed)
                        ++result;
                return result;
            }
        })*/
        bugTrackerApp.filter("closedCount", function($filter){
            return function(data){
                var builtInFilter = $filter('filter');
                return builtInFilter(data, {isClosed : true}).length;
            }
        });
        bugTrackerApp.value("appDefaults", {
            trimLength : 20,
            bugDefault : {name : null, isClosed : true}
        });

        bugTrackerApp.filter("trimText", function(appDefaults){
            return function(data, trimLength){
                trimLength = trimLength || appDefaults.trimLength;
                return data.length < trimLength ? data : data.substr(0,trimLength) + "..."
            }
        });

        bugTrackerApp.value("momentApi", moment);
        bugTrackerApp.filter("toMoment", function(momentApi){
            return function(data){
                return momentApi(data).fromNow();
            };
        })
    </script>
</head>
<body ng-app="bugTrackerApp" ng-controller="bugsController">
    <h1>Bug Tracker</h1>
    <div class="stats" >
    <!--<span class="closed">{{(bugs | filter:{isClosed:true}).length}}</span> -->
    <span class="closed">{{bugs | closedCount}}</span>
    /
    <span>{{bugs.length}}</span></div>
    <div class="search">
        <label for="">Search :</label>
        <input type="text" ng-model="searchBug.name">
        <label for="">Closed ?</label>
        <input type="checkbox" ng-model="searchBug.isClosed" >
        <a href="#" ng-click="searchBug.isClosed = undefined">Show All</a>
    </div>
    <div class="Order">
        <label for="">Order By:</label>
        <!--<input type="text" ng-model="sortBugBy.attrName">-->
        <select ng-model="sortBugBy.attrName">
            <option value="name">name</option>
            <option value="isClosed">isClosed</option>
        </select>
        <label for="">Descending ? :</label>
        <input type="checkbox" name="" id="" ng-model="sortBugBy.descending">
    </div>
    <div class="content">
        <label for="">Bug :</label>
        <input type="text" name="" id="" ng-model="newBug">
        <input type="button" value="Add New" ng-click="addNew()">
        <input type="button" value="Remove Closed" ng-click="removeClosed()">
        <ol>
            <li ng-repeat="bug in bugs | filter:searchBug | orderBy:sortBugBy.attrName: sortBugBy.descending"
            > <div>
                <div class="title" ng-click="toggle(bug)" ng-class="{closed : bug.isClosed}">
                    {{bug.name | trimText:30}}
                </div>
                <div class="timestamp">{{bug.createdAt | toMoment}}</div>
            </div>
            </li>
        </ol>
    </div>
</body>
</html>
